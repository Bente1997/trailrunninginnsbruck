<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monthly Calendar View</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    
    <style>
        :root{
            --brand:#FFCCC9; --ink:#0f172a; --muted:#64748b; --bg:#ffffff; --card:#ffffff; --ring:#e2e8f0;
            --radius:14px; --pageMax:1200px;
        }
        *{box-sizing:border-box}
        body{font-family:Inter,system-ui,Arial,sans-serif; color:var(--ink); margin:0; background:var(--bg);} 
        .container{max-width:var(--pageMax); margin:0 auto; padding:0 1rem;}

        .toolbar{display:flex; gap:.75rem; align-items:center; justify-content:space-between; padding:1rem 1.25rem; position:sticky; top:0; background:var(--bg); border-bottom:1px solid var(--ring); z-index:5}
        .title{display:flex; align-items:center; gap:.75rem; flex-wrap:wrap}
        .title h1{font-size:1.3rem; margin:0; font-weight:700}
        .btn{padding:.5rem .8rem; border:1px solid var(--ring); border-radius:10px; background:white; cursor:pointer; font-size:1rem}
        .btn:hover{filter:brightness(0.98)}
        .controls{display:flex; gap:.5rem; align-items:center;}

        select.filterSelect {
            padding: .4rem .7rem;
            border: 1px solid var(--ring);
            border-radius: 999px;
            background: white;
            color: var(--muted);
            font-size: 1rem;
            appearance: none;
            cursor: pointer;
            min-width: 110px;
        }

        .calendar-wrapper {
            padding: 1.5rem 1rem;
            max-width: 1100px;
            margin: 0 auto;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--ring);
            border: 1px solid var(--ring);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .day-header-cell {
            background: var(--bg);
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: var(--bg);
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
        }

        .calendar-day.other-month {
            background: #fafafa;
            opacity: 0.6;
        }

        .calendar-day.today {
            background: rgba(255, 204, 201, 0.1);
        }

        .day-number {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 0.5rem;
        }

        .calendar-day.today .day-number {
            background: var(--brand);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .event-pill {
            background: var(--card);
            border: 1px solid var(--ring);
            border-radius: 8px;
            padding: 0.4rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .event-pill:hover {
            border-color: var(--brand);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .event-pill.filtered {
            display: none;
        }

        .event-pill-title {
            font-weight: 600;
            color: var(--ink);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-pill-time {
            color: var(--muted);
            font-size: 0.75rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        .modal.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background-color: var(--bg);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            cursor: pointer;
            color: var(--muted);
        }

        .modal-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0.5rem 0 1rem 0;
        }

        .tag {
            padding: 0.2rem 0.6rem;
            border: 1px solid var(--ring);
            border-radius: 999px;
            color: var(--muted);
            font-size: 0.85rem;
        }

        .modal-cta {
            display: inline-block;
            margin-top: 1rem;
            padding: .5rem 1rem;
            background: var(--brand);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
        }

        .add-to-cal-btn {
            display: inline-block;
            margin-top: 0.5rem;
            margin-left: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--ring);
            border-radius: 10px;
            background: var(--bg);
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
        }

        /* Mobile List View */
        .mobile-list-view {
            display: none;
        }

        .event-list-item {
            background: var(--card);
            border: 1px solid var(--ring);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-list-item:hover {
            border-color: var(--brand);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .event-list-item.filtered {
            display: none;
        }

        .event-list-date {
            font-size: 0.85rem;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .event-list-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 0.4rem;
        }

        .event-list-time {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
        }

        .event-list-tags {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .event-list-location {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 0.4rem;
        }

        @media (max-width: 768px) {
            .title h1 {
                font-size: 1.1rem;
            }
            
            .calendar-wrapper {
                display: none;
            }
            
            .mobile-list-view {
                display: block;
                padding: 1rem;
                max-width: 600px;
                margin: 0 auto;
            }
            
            .mobile-list-empty {
                text-align: center;
                color: var(--muted);
                padding: 2rem;
                font-style: italic;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <div class="title">
                <button class="btn" id="prevBtn">‚Üê</button>
                <button class="btn" id="todayBtn">Today</button>
                <button class="btn" id="nextBtn">‚Üí</button>
                <h1 id="monthTitle">October 2025</h1>
            </div>
            <div class="controls">
                <select id="filterSelect" class="filterSelect">
                    <option value="all" selected>All</option>
                </select>
            </div>
        </div>

        <div class="calendar-wrapper">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title"></h2>
            <div id="modal-tags" class="modal-tags"></div>
            <p id="modal-time"></p>
            <p id="modal-location"></p>
            <p id="modal-desc"></p>
            <div>
                <a id="modal-book-link" href="#" target="_blank" class="modal-cta">Book</a>
                <a id="modal-cal-link" href="#" target="_blank" class="add-to-cal-btn">üìÖ Add to Calendar</a>
            </div>
        </div>
    </div>

    <script>
        const DATA_SOURCES = [
            { organizer: 'DNA Trails', singles: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcZJm7p8vV6KnyB2ZggoEQ9yi0maYoaTJk9QVvDByfrcJmtcp8v0emaURB6gWsX05wstW11FqdqIjv/pub?gid=0&single=true&output=tsv', recurring: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcZJm7p8vV6KnyB2ZggoEQ9yi0maYoaTJk9QVvDByfrcJmtcp8v0emaURB6gWsX05wstW11FqdqIjv/pub?gid=1719385230&single=true&output=tsv', cancelled: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcZJm7p8vV6KnyB2ZggoEQ9yi0maYoaTJk9QVvDByfrcJmtcp8v0emaURB6gWsX05wstW11FqdqIjv/pub?gid=469608839&single=true&output=tsv' },
        ];

        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function addWeeks(d,n){ return addDays(d, n*7); }
        function addMonths(d,n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
        function startOfMonth(d){ const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
        function endOfMonth(d){ const x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(0); x.setHours(23,59,59,999); return x; }
        function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
        function fmtTime(d){ return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit', hour12: false}); }
        function sameYMD(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
        function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }

        async function fetchCSV(url){ const res=await fetch(url); if(!res.ok) throw new Error('CSV load failed'); return await res.text(); }
        function parseCSV(text){
            const rows=[]; let i=0, field='', row=[], inQuotes=false;
            function pushField(){ row.push(field); field=''; }
            function pushRow(){ rows.push(row); row=[]; }
            while(i<text.length){
                const ch=text[i];
                if(inQuotes){
                    if(ch==='"'){
                        if(text[i+1]==='"'){ field+='"'; i+=2; continue; }
                        inQuotes=false; i++; continue;
                    } else { field+=ch; i++; continue; }
                } else {
                    if(ch==='"'){ inQuotes=true; i++; continue; }
                    if(ch==='\t'){ pushField(); i++; continue; }
                    if(ch==='\n'){ pushField(); pushRow(); i++; continue; }
                    if(ch==='\r'){ i++; continue; }
                    field+=ch; i++;
                }
            }
            if(field!=='' || row.length){ pushField(); pushRow(); }
            if(rows.length===0) return {header:[], records:[]};
            const header=rows[0].map(h=>h.trim());
            const records=rows.slice(1).filter(r=>r.length && r.some(c=>c.trim()!==''));
            return {header, records};
        }
        function normHeader(n){
            const t=(n||'').trim().toLowerCase();
            if(['dag','datum','date'].includes(t)) return 'dag';
            if(['title','titel'].includes(t)) return 'title';
            if(['begintijd','start','starttijd','from', 'start_time'].includes(t)) return 'begintijd';
            if(['eindtijd','eind','endtijd','until','to', 'end_time'].includes(t)) return 'eindtijd';
            if(['sport','type','categorie','lesson','class'].includes(t)) return 'sport';
            if(['beschrijving','omschrijving','description','notes'].includes(t)) return 'beschrijving';
            if(['organizer','organisatie','provider','studio'].includes(t)) return 'organizer';
            if(['startplek','locatie','location','venue'].includes(t)) return 'startplek';
            if(['boeklink','bookingurl','link','url'].includes(t)) return 'boeklink';
            if(['herhaling','repeat','rrule','frequency'].includes(t)) return 'herhaling';
            if(['tot','einddatum','until','repeat_until','until_date'].includes(t)) return 'tot';
            if(['docent','teacher','instructor'].includes(t)) return 'docent';
            return t;
        }
        function rowToObj(header,row){ const obj={}; for(let i=0;i<header.length;i++){ obj[normHeader(header[i])] = (row[i]||'').trim(); } return obj; }
        function parseDateNL(s){ const t=(s||'').trim(); if(!t) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return new Date(t); const m=t.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/); if(m){ const d=m[1], mo=m[2], y=m[3]; const Y=(y.length===2?('20'+y):y); return new Date(`${Y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`);} const d2=new Date(t); return isNaN(+d2)?null:d2; }
        function parseTimeHM(s){ const m=(s||'').trim().match(/^(\d{1,2}):(\d{2})$/); if(!m) return null; return {h:+m[1], m:+m[2]}; }
        function combineDateTime(d,hm){ const x=new Date(d); x.setHours(hm.h, hm.m, 0, 0); return x; }

        function findNthDayOfMonth(year, monthIndex, dayOfWeek, n) {
            let date = new Date(year, monthIndex, 1);
            let count = 0;
            while (date.getMonth() === monthIndex) {
                if (date.getDay() === dayOfWeek) {
                    count++;
                    if (count === n) return new Date(date);
                }
                date.setDate(date.getDate() + 1);
            }
            return null;
        }

        function toEvent(obj, fallbackOrganizer){
            const dag=parseDateNL(obj.dag); const st=parseTimeHM(obj.begintijd||''); const en=parseTimeHM(obj.eindtijd||'');
            const start=(dag&&st)?combineDateTime(dag,st):null; const end=(dag&&en)?combineDateTime(dag,en):null;
            return {
                title: obj.title||'Lesson', start, end,
                teacher: obj.docent||'', type: obj.sport||'Unknown',
                bookingUrl: obj.boeklink||'',
                startplek: obj.startplek||'', beschrijving: obj.beschrijving||'',
                organizer: obj.organizer||fallbackOrganizer||''
            };
        }

        async function loadSources(){
            const now=new Date();
            const rangeStart=addMonths(startOfMonth(now), -2);
            const rangeEnd=addMonths(endOfMonth(now), 6);
            const all=[];

            for(const src of DATA_SOURCES){
                if(src.singles){
                    try{
                        const txt=await fetchCSV(src.singles); 
                        const {header,records}=parseCSV(txt);
                        for(const r of records){ 
                            const o=rowToObj(header,r); 
                            const ev=toEvent(o, src.organizer); 
                            if(ev.start && ev.end && ev.end>=rangeStart && ev.start<=rangeEnd) all.push(ev); 
                        }
                    }catch(e){ console.warn('singles', e); }
                }

                const cancels=new Set();
                if(src.cancelled){
                    try{
                        const txt=await fetchCSV(src.cancelled); 
                        const {header,records}=parseCSV(txt);
                        for(const r of records){ 
                            const o=rowToObj(header,r); 
                            const d=parseDateNL(o.dag); 
                            if(!d) continue; 
                            const dateKey=d.toISOString().slice(0,10); 
                            const org=(o.organizer||src.organizer||'').trim(); 
                            const sport=(o.sport||'').trim(); 
                            const bt=(o.begintijd||'').trim(); 
                            cancels.add(`${dateKey}|${org}|${sport}|${bt}`); 
                            cancels.add(`${dateKey}|${org}|${sport}`);
                        } 
                    }catch(e){ console.warn('cancelled', e); }
                }

                if(src.recurring){
                    try{
                        const txt=await fetchCSV(src.recurring); 
                        const {header,records}=parseCSV(txt);
                        for(const r of records){
                            const o=rowToObj(header,r);
                            const anchor=parseDateNL(o.dag); 
                            const st=parseTimeHM(o.begintijd||''); 
                            const en=parseTimeHM(o.eindtijd||''); 
                            if(!st||!en) continue;
                            const freq=(o.herhaling||'weekly').toLowerCase(); 
                            const until=o.tot? endOfDay(parseDateNL(o.tot)) : rangeEnd;
                            let curStart,curEnd;
                            if(anchor){ 
                                curStart=combineDateTime(anchor,st); 
                                curEnd=combineDateTime(anchor,en); 
                            } else { 
                                continue; 
                            }
                            
                            if(curStart > rangeStart) {
                                if(freq === 'monthly') {
                                    const originalDayOfWeek = curStart.getDay();
                                    const originalPosition = Math.ceil(curStart.getDate() / 7);
                                    const durationMs = curEnd.getTime() - curStart.getTime();
                                    
                                    while(curStart > addWeeks(rangeStart, -8)) {
                                        const prevMonth = new Date(curStart.getFullYear(), curStart.getMonth() - 1, 1);
                                        const prevDate = findNthDayOfMonth(
                                            prevMonth.getFullYear(),
                                            prevMonth.getMonth(),
                                            originalDayOfWeek,
                                            originalPosition
                                        );
                                        if(!prevDate || prevDate < rangeStart) break;
                                        prevDate.setHours(curStart.getHours(), curStart.getMinutes(), curStart.getSeconds(), curStart.getMilliseconds());
                                        curStart = prevDate;
                                        curEnd = new Date(prevDate.getTime() + durationMs);
                                    }
                                } else {
                                    while(curStart>addWeeks(rangeStart,-8)){ 
                                        const prev=addWeeks(curStart,-1); 
                                        const prevEnd=addWeeks(curEnd,-1); 
                                        if(prev<rangeStart) break;
                                        curStart=prev; 
                                        curEnd=prevEnd; 
                                    }
                                }
                            }
                            
                            while(curStart<=until && curStart<=rangeEnd){
                                if(curEnd>=rangeStart){
                                    const dKey=curStart.toISOString().slice(0,10); 
                                    const org=(o.organizer||src.organizer||'').trim(); 
                                    const sport=(o.sport||'').trim(); 
                                    const bt=(o.begintijd||'').trim();
                                    const k1=`${dKey}|${org}|${sport}|${bt}`; 
                                    const k2=`${dKey}|${org}|${sport}`;

                                    if(!(cancels.has(k1)||cancels.has(k2))){ 
                                        const ev=toEvent({...o, dag:dKey}, src.organizer); 
                                        ev.start=new Date(curStart); 
                                        ev.end=new Date(curEnd); 
                                        all.push(ev); 
                                    }
                                }
                                
                                if(freq==='monthly'){ 
                                    const originalDayOfWeek = curStart.getDay();
                                    const originalPosition = Math.ceil(curStart.getDate() / 7);
                                    const durationMs = curEnd.getTime() - curStart.getTime(); 
                                    const nextMonth = new Date(curStart.getFullYear(), curStart.getMonth() + 1, 1);
                                    const newDate = findNthDayOfMonth(
                                        nextMonth.getFullYear(), 
                                        nextMonth.getMonth(), 
                                        originalDayOfWeek, 
                                        originalPosition
                                    );
                                    if(newDate) {
                                        newDate.setHours(curStart.getHours(), curStart.getMinutes(), curStart.getSeconds(), curStart.getMilliseconds());
                                        curStart = newDate;
                                        curEnd = new Date(newDate.getTime() + durationMs); 
                                    } else {
                                        const monthAfter = new Date(nextMonth.getFullYear(), nextMonth.getMonth() + 1, 1);
                                        const newDateAfter = findNthDayOfMonth(
                                            monthAfter.getFullYear(),
                                            monthAfter.getMonth(),
                                            originalDayOfWeek,
                                            originalPosition
                                        );
                                        if(newDateAfter) {
                                            newDateAfter.setHours(curStart.getHours(), curStart.getMinutes(), curStart.getSeconds(), curStart.getMilliseconds());
                                            curStart = newDateAfter;
                                            curEnd = new Date(newDateAfter.getTime() + durationMs);
                                        } else {
                                            break;
                                        }
                                    }
                                } else { 
                                    curStart=addWeeks(curStart,1); 
                                    curEnd=addWeeks(curEnd,1);
                                }
                            }
                        }
                    }catch(e){ console.warn('recurring', e); }
                }
            }
            return all;
        }

        let monthOffset = 0;
        let activeFilter = 'all';
        let EVENTS = [];

        const modalEl = document.getElementById('eventModal');
        const closeBtn = document.querySelector('.close-btn');
        const monthTitle = document.getElementById('monthTitle');
        const calendarGrid = document.getElementById('calendarGrid');
        const filterSelect = document.getElementById('filterSelect');

        function createGoogleCalendarLink(eventData) {
            const title = encodeURIComponent(eventData.title || '');
            const location = encodeURIComponent(eventData.startplek || '');
            const description = encodeURIComponent(eventData.beschrijving || '');
            const startDate = new Date(eventData.start);
            const endDate = new Date(eventData.end);
            const formatISO = (d) => d.toISOString().replace(/[:-]/g, '').slice(0, 15) + 'Z';
            const dates = `${formatISO(startDate)}/${formatISO(endDate)}`;
            return `https://calendar.google.com/calendar/r/eventedit?text=${title}&dates=${dates}&details=${description}&location=${location}`;
        }

        function showModal(eventData) {
            document.getElementById('modal-title').textContent = eventData.title;
            
            const modalTags = document.getElementById('modal-tags');
            modalTags.innerHTML = '';
            
            const organizerTag = document.createElement('span');
            organizerTag.className = 'tag';
            organizerTag.textContent = eventData.organizer || 'Unknown';
            modalTags.appendChild(organizerTag);
            
            const sportTag = document.createElement('span');
            sportTag.className = 'tag';
            sportTag.textContent = eventData.type || 'Unknown';
            modalTags.appendChild(sportTag);

            document.getElementById('modal-time').textContent = `${fmtTime(new Date(eventData.start))}‚Äì${fmtTime(new Date(eventData.end))}`;
            document.getElementById('modal-location').innerHTML = `${eventData.startplek ? 'üìç ' + eventData.startplek : 'No location specified'}`;
            document.getElementById('modal-desc').textContent = eventData.beschrijving || 'No description available.';
            
            const bookLink = document.getElementById('modal-book-link');
            bookLink.href = eventData.bookingUrl;
            bookLink.style.display = eventData.bookingUrl ? 'inline-block' : 'none';
            
            const calLink = document.getElementById('modal-cal-link');
            calLink.href = createGoogleCalendarLink(eventData);
            
            modalEl.classList.add('active');
        }

        function renderMonth() {
            const today = new Date();
            const currentMonth = addMonths(startOfMonth(today), monthOffset);
            
            monthTitle.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = startOfMonth(currentMonth);
            const startDate = startOfWeek(firstDay);
            
            calendarGrid.innerHTML = '';
            
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayNames.forEach(name => {
                const header = document.createElement('div');
                header.className = 'day-header-cell';
                header.textContent = name;
                calendarGrid.appendChild(header);
            });
            
            let date = new Date(startDate);
            for (let i = 0; i < 42; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const isCurrentMonth = date.getMonth() === currentMonth.getMonth();
                const isToday = sameYMD(date, today);
                
                if (!isCurrentMonth) dayCell.classList.add('other-month');
                if (isToday) dayCell.classList.add('today');
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();
                dayCell.appendChild(dayNumber);
                
                const dayEvents = EVENTS.filter(e => sameYMD(new Date(e.start), date));
                
                if (dayEvents.length > 0) {
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'day-events';
                    
                    dayEvents.forEach(event => {
                        const pill = document.createElement('div');
                        pill.className = 'event-pill';
                        if (activeFilter !== 'all' && event.type !== activeFilter) {
                            pill.classList.add('filtered');
                        }
                        
                        const pillTitle = document.createElement('div');
                        pillTitle.className = 'event-pill-title';
                        pillTitle.textContent = event.title;
                        pill.appendChild(pillTitle);
                        
                        const pillTime = document.createElement('div');
                        pillTime.className = 'event-pill-time';
                        pillTime.textContent = fmtTime(new Date(event.start));
                        pill.appendChild(pillTime);
                        
                        pill.addEventListener('click', () => showModal(event));
                        eventsContainer.appendChild(pill);
                    });
                    
                    dayCell.appendChild(eventsContainer);
                }
                
                calendarGrid.appendChild(dayCell);
                date = addDays(date, 1);
            }
        }

        function rebuildFilters() {
            const sports = Array.from(new Set(EVENTS.map(e => e.type).filter(Boolean))).sort();
            const opts = ['<option value="all">All</option>'].concat(sports.map(t => `<option value="${t}">${t}</option>`));
            filterSelect.innerHTML = opts.join('');
        }

        closeBtn.addEventListener('click', () => modalEl.classList.remove('active'));
        window.addEventListener('click', (e) => {
            if (e.target == modalEl) modalEl.classList.remove('active');
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            monthOffset--;
            renderMonth();
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            monthOffset++;
            renderMonth();
        });
        
        document.getElementById('todayBtn').addEventListener('click', () => {
            monthOffset = 0;
            renderMonth();
        });

        filterSelect.addEventListener('change', () => {
            activeFilter = filterSelect.value;
            renderMonth();
        });

        (async function init(){
            const loaded = await loadSources();
            EVENTS = loaded.sort((a,b) => new Date(a.start) - new Date(b.start));
            rebuildFilters();
            renderMonth();
        })();
    </script>
</body>
</html>